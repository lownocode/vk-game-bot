import { Chat } from "../db/models.js"
import { config } from "../../main.js"
import {
    chatMainKeyboard,
    chooseChatStatusKeyboard,
    modeKeyboard
} from "../keyboards/index.js"

export const onChatInviteMiddleware = async (event) => {
    if (event.eventMemberId !== -config["vk-group"].id) return

    const chat = await Chat.findOne({ where: { peerId: event.peerId } })

    if (!chat) {
        await Chat.create({
            peerId: event.peerId
        })

        return event.send(
            "üëã –û–ø–∞, —è –≤ —á–∞—Ç–µ!\n" +
            "‚ö† –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç—É –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n" +
            "‚ÑπÔ∏è –£–ø—Ä–∞–≤–ª—è—Ç—å –±–æ—Ç–æ–º –º–æ–∂–µ—Ç –ª—é–±–æ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —á–∞—Ç–∞.\n\n" +
            "‚öôÔ∏è –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ—Å–µ–¥–æ–π –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ¬´–ß–∞—Ç¬ª\n" +
            "–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –±–µ—Å–µ–¥—ã", {
                keyboard: chooseChatStatusKeyboard
            }
        )
    }

    if (!chat.status) {
        return event.send(
            "üëã –ò —Å–Ω–æ–≤–∞ –ø—Ä–∏–≤–µ—Ç!\n" +
            "üåü –°—Ç–∞—Ç—É—Å –±–µ—Å–µ–¥—ã —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å.\n\n" +
            "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–¥–∞—Ç—å –±–æ—Ç—É –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã", {
                keyboard: chooseChatStatusKeyboard
            }
        )
    }

    if (!chat.mode) {
        return event.send(
            "üëã –ò —Å–Ω–æ–≤–∞ –ø—Ä–∏–≤–µ—Ç!\n" +
            "üåü –†–µ–∂–∏–º –±–µ—Å–µ–¥—ã —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —Ä–µ–∂–∏–º–æ–≤.\n\n" +
            "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–¥–∞—Ç—å –±–æ—Ç—É –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã", {
                keyboard: modeKeyboard()
            }
        )
    }

    event.send(
        "üëã –ò —Å–Ω–æ–≤–∞ –ø—Ä–∏–≤–µ—Ç!\n" +
        "üåü –†–µ–∂–∏–º –±–µ—Å–µ–¥—ã –≤–æ–∑–æ–±–Ω–æ–≤–ª—ë–Ω. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–¥–∞—Ç—å –±–æ—Ç—É –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã\n\n" +
        "‚ú® –£–¥–∞—á–Ω–æ–π –∏–≥—Ä—ã!", {
            keyboard: chatMainKeyboard(chat.mode)
        }
    )
}